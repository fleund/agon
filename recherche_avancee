<!DOCTYPE html>

<?php include('bdd.php') ?>

<html>

    <head>
        <meta charset="UTF-8">
        <title>Recherche avancée</title>
        <link rel="stylesheet" href="Accueil.css">
    </head>

    <body>
        <h1>Recherche avancée</h1>
        <form method="post" action="recherche_avance.php" class="champ_recherche">
            <select name="critere1" class="critere">
                <option value="">Choisir un sport</option>
                <?php // Affichage de la liste déroulante des sports
                    $reponse = $bdd->query('SELECT * FROM liste_sports ORDER BY nom');
                    while ($donnees = $reponse->fetch()) {
                        echo '<option';
                        if (isset($_POST['critere1'])) {
                            if ($donnees['nom']==$_POST['critere1']) {echo ' selected="selected"';}
                        }
                        echo '>' . $donnees['nom'] . '</option>';
                    }
                ?>
            </select>
            <select name="critere2" class="critere">
                <option value="">Choisir un département</option>
                <?php // Affichage de la liste déroulante des départements
                    $reponse = $bdd->query('SELECT * FROM departement ORDER BY numero');
                    while ($donnees = $reponse->fetch()) {
                        echo '<option value="' . $donnees['nom'] . '"';
                        if (isset($_POST['critere2'])) {
                            if ($donnees['nom']==$_POST['critere2']) {echo ' selected="selected"';}
                        }
                        echo '>' . $donnees['numero'] . ' - ' . $donnees['nom'] . '</option>';
                    }
                ?>
            </select>
            <input type="text" name="critere3" class="critere" placeholder="Nom de groupe"
            <?php
                if (isset($_POST['critere3'])) {
                    if (!empty($_POST['critere3'])) {echo ' value="'. $_POST['critere3'] . '"';}
                }
                $reponse->closeCursor();
            ?>
            >
            <input type="number" name="critere4" class="critere" placeholder="Nombre minimum de membres"
            <?php
                if (isset($_POST['critere4'])) {
                    if (!empty($_POST['critere4'])) {echo ' value="'. $_POST['critere4'] . '"';}
                }
                $reponse->closeCursor();
            ?>
            >
            <input type="number" name="critere5" class="critere" placeholder="Nombre maximum de membres"
            <?php
                if (isset($_POST['critere5'])) {
                    if (!empty($_POST['critere5'])) {echo ' value="'. $_POST['critere5'] . '"';}
                }
                $reponse->closeCursor();
            ?>
            >
            <input id="search-btn" type="submit" value="Rechercher" name="submit"/> 
        </form>

        <?php // Recherche et affichage des résultats
            if (isset($_POST['critere1'])) {
                echo '<table><caption>Résultats de la recherche</caption>
                    <tr>
                        <th>Nom du groupe</th>
                        <th>Sport pratiqué</th>
                        <th>Département</th>
                        <th>Nombre de membres</th>
                    </tr>';
                if (empty($_POST['critere4'])) {$_POST['critere4']=0;}
                if (empty($_POST['critere5'])) {$_POST['critere5']=10000;}
                if ($_POST['critere4']<$_POST['critere5']) {
                    $reponse = $bdd->prepare('SELECT * FROM groupe WHERE sport LIKE :tmp1 AND departement LIKE :tmp2 AND nom LIKE :tmp3 AND participants >= :tmp4 AND participants <= :tmp5 ORDER BY nom');
                    $reponse->execute(array(
                        'tmp1' => '%' . $_POST['critere1'] . '%',
                        'tmp2' => '%' . $_POST['critere2'] . '%',
                        'tmp3' => '%' . $_POST['critere3'] . '%',
                        'tmp4' => $_POST['critere4'],
                        'tmp5' => $_POST['critere5']
                    ));
                    while ($donnees = $reponse->fetch()) {
                        $verif=True;
                        echo '<tr>'
                            . '<td><a href="">' . $donnees['nom'] . '</a></td>'
                            . '<td>' . $donnees['sport'] . '</td>'
                            . '<td>' . $donnees['departement'] . '</td>'
                            . '<td>' . $donnees['participants'] . '</td>'
                        . '</tr>';
                    }
                    echo '</table>';
                    if (!isset($verif)) {echo 'Pas de résultat !';}
                }
                else {echo '<strong class="erreur">Le nombre maximum de membres doit être supérieur au nombre minimum !</strong>';}
            }
        ?>
    </body>
</html>
